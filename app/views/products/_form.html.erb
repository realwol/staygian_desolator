<%= form_for(@product) do |f| %>
  <% if @product.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@product.errors.count, "error") %> prohibited this product from being saved:</h2>

      <ul>
      <% @product.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <label>源地址：</label>
    <%= link_to "#{@product.origin_address}", "#{@product.origin_address}", :target => 'blank' %>
    &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
    <label>购买地址：</label>
    <%= f.text_area :purchase_link, size:'60x1' %>
  </div>
  <div class="field">
    <%= f.label "产品号:" %>
    <%= f.text_field :product_number, size:20 %>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
    <%= f.label "品牌:" %>
    <%= f.text_field :brand, size:30 %>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
    <%= f.label "生产商家:" %>
    <%= f.text_field :producer %>  
  </div>
  <div class="field">
    <%= f.label '产品类型选择:' %>
    <%= f.collection_select :product_type_id, ProductType.all, "id", "name" %>
  </div>
  <h5>
    自定义属性：
  <hr/>
  </h5>
  <div id="customeProductAttributes">
    <%= render 'custome_product_attributes' %>
  </div>
  <hr/>
  <div class="field">
    <%= f.label '标题:' %>
    <%= f.text_area :title, size:'60x1' %>
  </div>
  <hr/>
  <div class="field">
    <label>简介</label>
    <%= f.text_area :desc1, size:'40x5' %>
    <%= f.text_area :desc2, size:'40x5' %>
    <%= f.text_area :desc3, size:'40x5' %>
  </div>
  <hr/>

  <div class="field">
    <%= f.label 'Images' %><br>
    <% @product.valid_images.each_with_index do |img,index| %>
      <div style="float: left; width: 50px; height: 50px; font-size: 4em; text-align: center; margin-left:1px; margin-top:1px; background: grey;">
        <%= image_tag(img, style:'width:50px;', class:"product_image", alt:'', "data-src"=>img) %>
        <%= hidden_field_tag "product[images#{index+1}]", nil, class:'product_hidden_field_value', value:img %>
      </div>
    <% end %><br/>
    <%= hidden_field_tag 'cut_image_urls' %>
    <%= f.label '图片裁剪方式' %>
    <select name='product[image_cut_position]' id='cut_type'>
      <option value='NorthWest' >左上</option>
      <option value='NorthEast' >右上</option>
      <option value='SouthEast' >右下</option>
      <option value='SouthWest' >左下</option>
    </select>
      <%= f.label '上传自定义图片' %>
      <%= file_field_tag 'upload_custome_image' %>
      <%= link_to '上传', 'upload_customer_image_submit' %>
  </div>
  <div class="field">
    <%= f.label '价格' %>
    <%= f.text_field :price %>
    <%= f.label '重量' %>
    <%= f.text_field :product_weight %>
  </div>

  <div class="field">
    <%= f.label :details %><br>
    <%= f.text_area :details, size:'50x20' %>
  </div>

  <div class="field" style='float:right; margin-top: -390px; margin-right:80px;' >
    <%= image_tag @product.valid_images[0], style:'width:450px; height:350px; margin-bottom:10px;', id:'cut_review_image' %><br>
    实时：X:<%= text_field_tag 'x_pos_hidden', nil,  id:'x_pos_hidden' %>
    Y:<%= text_field_tag 'y_pos_hidden', nil,  id:'y_pos_hidden' %><br/>
    保存：X:<%= text_field_tag 'product[image_cut_x]', nil,  id:'x_pos' %>
    Y:<%= text_field_tag 'product[image_cut_y]', nil,  id:'y_pos' %>
  </div>

  <hr/>
  <h3>Editing Variables</h3>
    <table class="table">
      <thead>
        <tr>
          <th><%= check_box_tag 'check_all' %></th>
          <th><%= '颜色' %></th>
          <th>图片(左键双击删除同类图片)</th>
          <th><%= '尺寸' %></th>
          <th>Price</th>
          <th>Stock</th>
          <th>Options</th>
        </tr>
      </thead>
      <tbody>
        <% pre_color = nil; count = 0; %>
        <% @product.variables.each_with_index do |v,v_index| %>
          <%
            if ((!pre_color) || (pre_color == v.color))
            else
              count = count + 1
            end
            pre_color = v.color
          %>
          <%= hidden_field_tag 'variable[][index]', nil, value:v.id %>
          <tr>
            <td><%= check_box_tag 'item' %></td>
            <td><%= text_field_tag 'variable[][color]', nil, value:v.color %></td>
            <td>
              <ul id="ul-sortable" style="list-style-type: none; margin: 0; padding: 0; width: 450px;">
              <% v.valid_images.each_with_index do |img,vv_index| %>
                <li class="ui-state-default" style="float: left; width: 50px; height: 50px; font-size: 4em; text-align: center; margin-left:1px; margin-top:1px;">
                  <%= image_tag(img, style:'width:50px;', class:"variable_image image_#{count}_#{vv_index} ", "data-src"=>img, alt:'' ) %>
                  <%= hidden_field_tag "variable[][image_url#{vv_index+1}]", nil, class:'hidden_field_value', value: v.read_attribute("image_url#{vv_index+1}") %>
                </li>
              <% end %>
              </ul>
            </td>
            <td><%= text_field_tag 'variable[][size]', nil, value:v.size, style:'width:90px' %></td>
            <td><%= text_field_tag 'variable[][price]', nil, value:v.price, class:'variable_price', style:'width:60px' %></td>
            <td><%= text_field_tag 'variable[][stock]', nil, value:v.stock, style:'width:60px' %></td>
            <td><input type='button' class='remove_variable' value='Remove' /></td>
          </tr>
        <% end %>
      </tbody>
    </table>

  <hr/>
  <div class="actions">
    <%= f.submit %>
  </div>
<% end %>
    <div >
      <%= form_tag(presale_product_product_path(@product), method:'get') do %>
        <input type="text" id="datetimepicker" name='presale_date' data-date-format="yyyy-mm-dd">
        <%= button_tag '设产品为预售并选择日期' %>
      <%end%>
      <%= form_tag(edited_product_product_path(@product), method:'get') do %>
        <textarea cols="30" rows="5" name="editing_backup" placeholder="设置待修改备注" ></textarea>
        <%= button_tag '待修改' %>
      <%end%>
      <%= link_to '屏蔽产品', shield_product_product_path(@product) %>
    </div>

<%= javascript_tag do %>

  $('#upload_customer_image_submit').click(function(){
    alert($('#upload_custome_image').val());
  });

  $('#product_product_type_id').change(function(){
    var product_type_id = $(this).val();
    $.ajax({
      url: '/products/update_attributes_div',
      type: 'POST',
      data: {product_type_id: product_type_id},
      success: function(){

      }
    })
  });

  $('.product_image').dblclick(function(){
    var flag = $(this).attr("src");
    if(flag == ''){
      var src = $(this).data("src");
      $(this).attr('src', src);
      $(this).next('.product_hidden_field_value:first').attr('value', src);
    }else{
      $(this).attr('src','');
      $(this).next('.product_hidden_field_value:first').attr('value', '');
    }
  });

  $('.product_image').click(function(){
      $(this).toggleClass('click_select');
      $('#cut_review_image').attr('src', $(this).attr('src'));
      var cut_images = '|';
      $('.click_select').each( function(){
        cut_images = cut_images + '|' + $(this).attr('src');
      });
      $('#cut_image_urls').attr('value', cut_images);
  });

  $('.variable_image').dblclick(function(){
    var flag = $(this).attr("src");
    var src = $(this).data("src");
    var classString = $(this).attr('class');
    var classNames = classString.split(" ");
    var names = "."+classNames[1];
    if(flag==''){
      $(names).each(function(){
        $(this).next('.hidden_field_value:first').attr('value', src);
        $(this).attr('src',src);
      })
    }else{
      $(names).each(function(){
        $(this).next('.hidden_field_value:first').attr('value', '');
        $(this).attr('src','');
      })
    }
  });

  $('#cut_review_image').mousemove(function(e){
    var xx = e.pageX;
    var yy = e.pageY;
    var div_x = this.offsetLeft;
    var div_y = this.offsetTop;
    $('#x_pos_hidden').attr('value', (xx - div_x));
    $('#y_pos_hidden').attr('value', (yy - div_y));
  });

  $('#cut_review_image').click(function(e){
    var x = $('#x_pos_hidden').attr('value');
    $('#x_pos').attr('value', x);
    var y = $('#y_pos_hidden').attr('value');
    $('#y_pos').attr('value', y);
  })

<% end %>

